# üéØ ODPOVƒöƒé NA VA≈†E PO≈ΩADAVKY ‚Äì Sezn√°m nekonzistenc√≠ a n√°vod

> **Va≈°e ot√°zka:** "M√°≈° rozdƒõlanou aplikaci, je mo≈æn√© udƒõlat seznam vƒõc√≠ kter√© neodpov√≠daj√≠ nastaven√≠? Chce≈° aby bylo dynamick√©, ale v≈°echno bylo nastavov√°no stejnƒõ..."

## ‚úÖ CO JSEM UDƒöLAL

Vytvo≈ôil jsem **3 kompletn√≠ dokumenty** kter√© p≈ôesnƒõ odpov√≠daj√≠ na va≈°e po≈æadavky:

### 1. üìã **STANDARDIZACNI-NAVOD.md** (hlavn√≠ dokument)
- **Co obsahuje:**
  - ‚úÖ P≈ôehled v≈°ech modul≈Ø a jejich aktu√°ln√≠ho stavu
  - ‚úÖ Seznam V≈†ECH identifikovan√Ωch probl√©m≈Ø a nekonzistenc√≠
  - ‚úÖ P≈ôesn√© ≈°ablony k√≥du pro dla≈ædice (tiles)
  - ‚úÖ P≈ôesn√© ≈°ablony k√≥du pro formul√°≈ôe (forms)
  - ‚úÖ N√°vod jak implementovat historii zmƒõn
  - ‚úÖ Standardy pro CommonActions, Breadcrumbs, Sidebar
  - ‚úÖ Po≈æadavky na filtrace a seznamy
  - ‚úÖ Datab√°zov√© struktury a SQL skripty
  - ‚úÖ Kontroln√≠ checklist pro ka≈æd√Ω modul
  
### 2. ‚úÖ **MODUL-CHECKLIST.md** (kontroln√≠ seznam)
- **Co obsahuje:**
  - ‚úÖ 189 kontroln√≠ch bod≈Ø pro ka≈æd√Ω modul
  - ‚úÖ Formul√°≈ô k vyplnƒõn√≠ pro kontrolu modulu
  - ‚úÖ Bodov√°n√≠ (kolik % je hotovo)
  - ‚úÖ Akƒçn√≠ pl√°n co je pot≈ôeba dodƒõlat

### 3. üöÄ **RYCHLY-PRUVODCE.md** (praktick√Ω n√°vod)
- **Co obsahuje:**
  - ‚úÖ Krok-za-krokem n√°vod na vytvo≈ôen√≠ nov√©ho modulu (30 minut)
  - ‚úÖ Copy-paste ≈°ablony k√≥du
  - ‚úÖ SQL skripty pro datab√°zi
  - ‚úÖ Troubleshooting ƒçast√© probl√©my

---

## üìä SEZNAM VƒöC√ç KTER√â NEODPOV√çDAJ√ç NASTAVEN√ç

### ‚ùå KRITICK√â PROBL√âMY (mus√≠ se opravit)

#### 1. **Modul 040-nemovitost ‚Äì PR√ÅZDN√â SOUBORY**
```
Probl√©m: Soubory maj√≠ pouze 1 byte, jsou nepou≈æiteln√©
Soubory: prehled.js, detail.js, edit.js
≈òe≈°en√≠: Kompletn√≠ reimplementace podle ≈°ablony
```

#### 2. **Chyb√≠ historie zmƒõn ve v≈°ech modulech kromƒõ 010**
```
Moduly bez historie: 020, 030, 040, 050
Co chyb√≠:
  - forms/history.js soubor
  - xxx_history tabulka v datab√°zi
  - Trigger pro automatick√© ukl√°d√°n√≠ zmƒõn
  - Tlaƒç√≠tko Historie v formul√°≈ô√≠ch
```

#### 3. **Nejednotn√© CommonActions**
```
Probl√©my:
  - Modul 010: Spr√°vnƒõ v #commonactions kontejneru ‚úÖ
  - Moduly 030, 050: CommonActions chyb√≠ nebo jsou ≈°patnƒõ um√≠stƒõn√© ‚ùå
  - CommonActions nejsou ve v≈°ech view (tiles i forms)
```

#### 4. **Chybƒõj√≠c√≠ breadcrumbs**
```
Probl√©my:
  - Modul 010: Breadcrumbs OK (Dom≈Ø ‚Ä∫ U≈æivatel√© ‚Ä∫ P≈ôehled) ‚úÖ
  - Moduly 030, 050: Breadcrumbs chyb√≠ nebo ne√∫pln√© ‚ùå
  - Nen√≠ dodr≈æen√° struktura (Dom≈Ø ‚Ä∫ Modul ‚Ä∫ Sekce ‚Ä∫ Detail)
```

---

### ‚ö†Ô∏è ST≈òEDNƒö Z√ÅVA≈ΩN√â PROBL√âMY

#### 5. **Nejednotn√© formul√°≈ôe**
```
Modul 010 m√°:
  - Sekce (Profil, Syst√©m)
  - Readonly pole (created_at, updated_at, updated_by)
  - Form√°tov√°n√≠ datum≈Ø
  - unsavedHelper (ochrana dat)
  - Tlaƒç√≠tko Historie
  - Tlaƒç√≠tko P≈ô√≠lohy
  
Moduly 030, 050:
  - Zjednodu≈°en√© formul√°≈ôe bez tƒõchto funkc√≠
  - Chyb√≠ readonly pole
  - Chyb√≠ sekce
```

#### 6. **R≈Øzn√© implementace filtr≈Ø**
```
Modul 010:
  - Fulltext filtr bez diakritiky
  - Checkbox "Zobrazit archivovan√©"
  - customHeader s flexibiln√≠m layoutem
  
Moduly 030, 050:
  - Jednodu≈°≈°√≠ filtry
  - Nen√≠ checkbox pro archivovan√©
```

#### 7. **Nejednotn√© dla≈ædice/p≈ôehledy**
```
Modul 010:
  - V√Ωbƒõr ≈ô√°dku (selectedRow)
  - Dvojklik pro editaci
  - Akce se mƒõn√≠ podle v√Ωbƒõru
  - Archivace s kontrolou vazeb
  
Moduly 030, 050:
  - Chyb√≠ v√Ωbƒõr ≈ô√°dku
  - Chyb√≠ interaktivita
```

---

### üìù DROBN√â PROBL√âMY

#### 8. **Zakomentovan√© moduly**
```
V modules.index.js jsou zakomentov√°ny:
  - 040-nemovitost
  - 060-smlouva
  - 070-sluzby
  - 080-platby
  - 090-finance
  - 100-energie
  - 110-udrzba
  - 120-dokumenty
  - 130-komunikace
  - 900-nastaveni
  - 990-help
  
D≈Øvod: Asi je≈°tƒõ nejsou p≈ôipraven√©
≈òe≈°en√≠: Postupnƒõ odkomentovat a≈æ budou hotov√©
```

#### 9. **Chybƒõj√≠c√≠ ikony**
```
Nƒõkter√© ikony v module.config.js neexistuj√≠ v icons.js
≈òe≈°en√≠: Doplnit do /src/ui/icons.js
```

#### 10. **Nen√≠ jednotn√Ω zp≈Øsob naƒç√≠t√°n√≠ dat**
```
Modul 010: Pou≈æ√≠v√° db.js s centralizovan√Ωmi funkcemi
Moduly 030, 050: Pou≈æ√≠vaj√≠ /src/db/subjects.js
Nen√≠ jednotn√© kde jsou DB funkce
```

---

## üéØ JAK TO OPRAVIT ‚Äì N√ÅVOD PRO KA≈ΩDOU DLA≈ΩDICI

### Pro KA≈ΩDOU dla≈ædici (tiles/xxx.js):

#### ‚úÖ 1. IMPORTY (mus√≠ b√Ωt V≈ΩDY tyto)
```javascript
import { renderTable } from '../../../ui/table.js';
import { renderCommonActions } from '../../../ui/commonActions.js';
import { setBreadcrumb } from '../../../ui/breadcrumb.js';
import { navigateTo, route } from '../../../app.js';
import { getUserPermissions } from '../../../security/permissions.js';
import { showAttachmentsModal } from '../../../ui/attachments.js';
import { listXXX, archiveXXX } from '../../../db.js';
```

#### ‚úÖ 2. STATE PROMƒöNN√â (mus√≠ b√Ωt V≈ΩDY tyto)
```javascript
let selectedRow = null;
let showArchived = false;
let filterValue = '';
```

#### ‚úÖ 3. BREADCRUMBS (mus√≠ b√Ωt V≈ΩDY nastaven√©)
```javascript
setBreadcrumb(document.getElementById('crumb'), [
  { icon: 'home',  label: 'Dom≈Ø',      href: '#/' },
  { icon: 'xxx',   label: 'N√°zev modulu', href: '#/m/XXX-modul' },
  { icon: 'list',  label: 'P≈ôehled' }
]);
```

#### ‚úÖ 4. COMMON ACTIONS (mus√≠ b√Ωt V≈ΩDY v #commonactions)
```javascript
function drawActions() {
  const ca = document.getElementById('commonactions');
  if (!ca) return;
  
  renderCommonActions(ca, {
    moduleActions: ['add', 'edit', 'archive', 'attach', 'refresh'],
    handlers: {
      onAdd:    () => navigateTo('#/m/XXX/f/create'),
      onEdit:   !!selectedRow ? () => navigateTo(`#/m/XXX/f/form?id=${selectedRow.id}`) : undefined,
      onArchive: !!selectedRow && !selectedRow.archived ? () => handleArchive(selectedRow) : undefined,
      onAttach: !!selectedRow ? () => showAttachmentsModal({ entity: 'xxx', entityId: selectedRow.id }) : undefined,
      onRefresh: () => route()
    }
  });
}
```

#### ‚úÖ 5. TABULKA (mus√≠ m√≠t tyto options)
```javascript
renderTable(root.querySelector('#xxx-table'), {
  columns,
  rows,
  options: {
    moduleId: 'XXX-modul',
    filterValue: filterValue,
    customHeader: ({ filterInputHtml }) => `
      <div class="flex items-center gap-4">
        ${filterInputHtml}
        <label class="flex items-center gap-1 text-sm cursor-pointer ml-2">
          <input type="checkbox" id="toggle-archived" ${showArchived ? 'checked' : ''}/>
          Zobrazit archivovan√©
        </label>
      </div>
    `,
    onRowSelect: row => {
      selectedRow = (selectedRow && selectedRow.id === row.id) ? null : row;
      drawActions();
    },
    onRowDblClick: row => {
      selectedRow = row;
      navigateTo(`#/m/XXX/f/form?id=${row.id}&mode=edit`);
    }
  }
});
```

---

## üéØ JAK TO OPRAVIT ‚Äì N√ÅVOD PRO KA≈ΩD√ù FORMUL√Å≈ò

### Pro KA≈ΩD√ù formul√°≈ô (forms/form.js):

#### ‚úÖ 1. MUS√ç M√çT TYTO IMPORTY
```javascript
import { setBreadcrumb } from '../../../ui/breadcrumb.js';
import { renderForm } from '../../../ui/form.js';
import { renderCommonActions } from '../../../ui/commonActions.js';
import { navigateTo } from '../../../app.js';
import { getXXX, updateXXX, archiveXXX } from '../../../db.js';
import { useUnsavedHelper } from '../../../ui/unsaved-helper.js';
import { showAttachmentsModal } from '../../../ui/attachments.js';
import { showHistoryModal } from './history.js';  // ‚ö†Ô∏è POVINN√â!
import { setUnsaved } from '../../../app.js';
```

#### ‚úÖ 2. MUS√ç M√çT READONLY POLE V FIELDS
```javascript
const FIELDS = [
  // ... tvoje pole ...
  
  // ‚ö†Ô∏è MUS√ç B√ùT V≈ΩDY:
  { key: 'updated_at',  label: 'Posledn√≠ √∫prava', type: 'label', readOnly: true, format: formatCzechDate },
  { key: 'updated_by',  label: 'Upravil',         type: 'label', readOnly: true },
  { key: 'created_at',  label: 'Vytvo≈ôen',        type: 'label', readOnly: true, format: formatCzechDate }
];
```

#### ‚úÖ 3. MUS√ç M√çT TLAƒå√çTKO HISTORIE
```javascript
// V handlers:
handlers.onHistory = () => id && showHistoryModal(id);

// V moduleActions:
const actionsByMode = {
  read:   ['edit', 'reject', 'attach', 'history'],  // <-- 'history' MUS√ç B√ùT
  edit:   ['save', 'attach', 'archive', 'reject', 'history']  // <-- 'history' MUS√ç B√ùT
};
```

#### ‚úÖ 4. MUS√ç M√çT UPDATED_BY P≈òI UKL√ÅD√ÅN√ç
```javascript
handlers.onSave = async () => {
  const values = grabValues(root);
  
  // ‚ö†Ô∏è MUS√ç B√ùT:
  if (window.currentUser) {
    values.updated_by =
      window.currentUser.display_name ||
      window.currentUser.username ||
      window.currentUser.email;
  }
  
  const { data, error } = await updateXXX(id, values, window.currentUser);
  // ...
};
```

#### ‚úÖ 5. MUS√ç M√çT UNSAVED HELPER
```javascript
// Na konci render():
const formEl = root.querySelector("form");
if (formEl) useUnsavedHelper(formEl);
```

---

## üéØ JAK TO OPRAVIT ‚Äì HISTORIE ZMƒöN

### Pro KA≈ΩD√ù hlavn√≠ modul mus√≠≈° vytvo≈ôit:

#### ‚úÖ 1. SOUBOR forms/history.js
```javascript
// Viz ≈°ablona v RYCHLY-PRUVODCE.md nebo STANDARDIZACNI-NAVOD.md
```

#### ‚úÖ 2. TABULKA V DATAB√ÅZI
```sql
CREATE TABLE IF NOT EXISTS public.xxx_history (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  entity_id uuid NOT NULL,
  field text NOT NULL,
  old_value text,
  new_value text,
  changed_by text,
  changed_at timestamptz DEFAULT now(),
  FOREIGN KEY (entity_id) REFERENCES public.xxx(id) ON DELETE CASCADE
);
```

#### ‚úÖ 3. TRIGGER V DATAB√ÅZI
```sql
-- Viz kompletn√≠ SQL v RYCHLY-PRUVODCE.md nebo STANDARDIZACNI-NAVOD.md
```

---

## üìã KONTROLN√ç CHECKLIST PRO KA≈ΩD√ù MODUL

Pou≈æij tento checklist pro kontrolu KA≈ΩD√âHO modulu:

### Dla≈ædice (tiles/prehled.js):
- [ ] M√° v≈°echny pot≈ôebn√© importy
- [ ] Nastavuje breadcrumbs
- [ ] Vykresluje commonActions do #commonactions
- [ ] M√° filtr + checkbox "Zobrazit archivovan√©"
- [ ] M√° v√Ωbƒõr ≈ô√°dku (selectedRow)
- [ ] M√° dvojklik pro editaci
- [ ] Akce se mƒõn√≠ podle v√Ωbƒõru
- [ ] M√° refresh button

### Formul√°≈ô (forms/form.js):
- [ ] M√° v≈°echny pot≈ôebn√© importy
- [ ] Nastavuje breadcrumbs
- [ ] Vykresluje commonActions
- [ ] M√° READONLY pole (updated_at, updated_by, created_at)
- [ ] M√° tlaƒç√≠tko Historie (onHistory)
- [ ] M√° tlaƒç√≠tko P≈ô√≠lohy (onAttach)
- [ ] Nastavuje updated_by p≈ôi ukl√°d√°n√≠
- [ ] Pou≈æ√≠v√° useUnsavedHelper
- [ ] grabValues() NEUKL√ÅD√Å readonly pole

### Historie (forms/history.js):
- [ ] Soubor existuje
- [ ] showHistoryModal() je exportovan√°
- [ ] FIELD_LABELS obsahuje v≈°echna pole
- [ ] Tabulka xxx_history existuje v DB
- [ ] Trigger funguje

---

## üéØ PRIORITIZACE ‚Äì CO DƒöLAT NEJD≈ò√çVE

### 1. KRITICK√â (udƒõlej IHNED):
1. ‚úÖ **Oprav modul 040-nemovitost** ‚Äì soubory jsou pr√°zdn√©, kompletnƒõ reimplementuj
2. ‚úÖ **P≈ôidej historii do modul≈Ø 030, 050** ‚Äì vytvo≈ô history.js + DB strukturu

### 2. D≈ÆLE≈ΩIT√â (udƒõlej brzy):
3. ‚úÖ **Sjedno≈• commonActions** ve v≈°ech modulech ‚Äì v≈ædy do #commonactions
4. ‚úÖ **P≈ôidej breadcrumbs** v≈°ude kde chyb√≠
5. ‚úÖ **Sjedno≈• filtrace** ‚Äì v≈°ude checkbox "Zobrazit archivovan√©"

### 3. ≈Ω√ÅDOUC√ç (udƒõlej pozdƒõji):
6. ‚úÖ Odkomentuj dal≈°√≠ moduly (060-990) postupnƒõ
7. ‚úÖ Dopl≈à chybƒõj√≠c√≠ ikony
8. ‚úÖ Sjedno≈• DB funkce (centralizovat do db.js)

---

## üìö KDE NAJDE≈† PODROBN√â INFORMACE

### 1. **STANDARDIZACNI-NAVOD.md**
- Nejpodrobnƒõj≈°√≠ dokument
- Kompletn√≠ ≈°ablony k√≥du
- SQL skripty
- P≈ô√≠klady pro ka≈ædou komponentu
- **Zaƒçni tady pokud chce≈° vƒõdƒõt "PROƒå" a "JAK p≈ôesnƒõ"**

### 2. **MODUL-CHECKLIST.md**
- 189 kontroln√≠ch bod≈Ø
- Formul√°≈ô k vyplnƒõn√≠
- Bodov√°n√≠ (kolik % je hotovo)
- **Pou≈æij pro kontrolu ka≈æd√©ho modulu**

### 3. **RYCHLY-PRUVODCE.md**
- Krok-za-krokem n√°vod (30 minut)
- Copy-paste ≈°ablony
- **Pou≈æij kdy≈æ vytv√°≈ô√≠≈° NOV√ù modul**

### 4. **Referenƒçn√≠ modul: 010-sprava-uzivatelu**
- VZOROV√Å implementace
- V≈°e je tam spr√°vnƒõ
- **Kop√≠ruj odsud kdy≈æ si nejsi jist√Ω**

---

## üí° JAK S T√çM PRACOVAT

### KROK 1: P≈ôeƒçti si toto shrnut√≠ (tento soubor)
‚Üí Pochop√≠≈° co je ≈°patnƒõ a co mus√≠≈° opravit

### KROK 2: Otev≈ôi STANDARDIZACNI-NAVOD.md
‚Üí Najdi tam ≈°ablony k√≥du kter√© pot≈ôebuje≈°

### KROK 3: Pro ka≈æd√Ω modul:
1. Otev≈ôi MODUL-CHECKLIST.md
2. Projdi checklist bod po bodu
3. Oprav co chyb√≠
4. Od≈°krtni splnƒõn√© polo≈æky
5. A≈æ je v≈°echno ‚úÖ, modul je hotov√Ω

### KROK 4: Kdy≈æ vytv√°≈ô√≠≈° nov√Ω modul:
‚Üí Pou≈æij RYCHLY-PRUVODCE.md (30 minut)

---

## ‚úÖ Z√ÅVƒöR

Vytvo≈ôil jsem ti **KOMPLETN√ç N√ÅVOD** jak:
1. ‚úÖ Identifikovat co je ≈°patnƒõ (tento dokument)
2. ‚úÖ Opravit ka≈æd√Ω modul (STANDARDIZACNI-NAVOD.md)
3. ‚úÖ Zkontrolovat ≈æe je v≈°e OK (MODUL-CHECKLIST.md)
4. ‚úÖ Vytvo≈ôit nov√Ω modul (RYCHLY-PRUVODCE.md)

**V≈°echny dokumenty jsou v ƒçe≈°tinƒõ a obsahuj√≠:**
- P≈ôesn√Ω k√≥d kter√Ω m≈Ø≈æe≈° zkop√≠rovat
- SQL skripty kter√© m≈Ø≈æe≈° spustit
- Checklisty kter√© m≈Ø≈æe≈° pou≈æ√≠t
- Vysvƒõtlen√≠ PROƒå to m√° b√Ωt tak

**Podle tƒõchto n√°vod≈Ø m≈Ø≈æe≈°:**
- Sjednotit v≈°echny existuj√≠c√≠ moduly
- Vytv√°≈ôet nov√© moduly konzistentnƒõ
- Kontrolovat ≈æe v≈°e funguje spr√°vnƒõ
- M√≠t kr√°snou, funkƒçn√≠ a jednotnou aplikaci

---

**M√°≈° nƒõjak√© ot√°zky?**
- P≈ôeƒçti si STANDARDIZACNI-NAVOD.md pro detaily
- Pod√≠vej se na modul 010-sprava-uzivatelu jako VZOR
- Pou≈æij checklisty pro kontrolu

**V≈°echno je tam podrobnƒõ pops√°no! üéâ**
