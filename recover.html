<script type="module">
import { supabase } from "./src/supabase.js";

const root = document.getElementById("content");

function ui(html){ root.innerHTML = html; }
function msg(text){ const m=document.getElementById("msg"); if(m) m.textContent=text; }

async function ensureSessionFromHash(){
  const p = new URLSearchParams(location.hash.slice(1));
  const ok = p.get("type")==="recovery" && p.get("access_token") && p.get("refresh_token");
  if(!ok) return false;
  const { data, error } = await supabase.auth.setSession({
    access_token: p.get("access_token"),
    refresh_token: p.get("refresh_token")
  });
  if (error || !data?.session) return false;
  // tokeny skryj až PO úspěchu
  history.replaceState({}, document.title, location.pathname);
  return true;
}

function renderSetPassword(){
  ui(`
    <input id="a" type="password" class="w-full border rounded p-2" placeholder="Nové heslo" />
    <input id="b" type="password" class="w-full border rounded p-2" placeholder="Potvrdit heslo" />
    <div class="flex gap-2"><button id="ok" class="px-3 py-2 bg-slate-900 text-white rounded">Uložit</button></div>
    <p id="msg" class="text-sm text-slate-500"></p>
  `);
  document.getElementById("ok").onclick = async () => {
    const a = document.getElementById("a").value.trim();
    const b = document.getElementById("b").value.trim();
    if (!a || a!==b){ msg("Hesla se neshodují."); return; }
    const { error } = await supabase.auth.updateUser({ password: a });
    if (error){ msg("Chyba: " + error.message); return; }
    msg("Hotovo, odhlašuji…");
    await supabase.auth.signOut();
    location.assign("/"); // po úspěchu domů
  };
}

function renderResend(){
  ui(`
    <p class="text-sm">Odkaz je neplatný nebo stránka byla obnovena. Pošli si reset znovu:</p>
    <input id="em" type="email" class="w-full border rounded p-2" placeholder="email" />
    <div class="flex gap-2"><button id="re" class="px-3 py-2 border rounded">Poslat reset</button></div>
    <p id="msg" class="text-sm text-slate-500"></p>
  `);
  document.getElementById("re").onclick = async () => {
    const email = document.getElementById("em").value.trim();
    msg("Posílám odkaz…");
    const { error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: location.origin + "/recover.html"
    });
    msg(error ? "Chyba: " + error.message : "Hotovo – zkontroluj e-mail.");
  };
}

(async () => {
  // 1) máš už session? (třeba po kliku z mailu, bez reloadu)
  const { data } = await supabase.auth.getSession();
  if (data?.session){ renderSetPassword(); return; }
  // 2) zkus ji založit z tokenů v hash
  if (await ensureSessionFromHash()){ renderSetPassword(); return; }
  // 3) jinak nabídni znovu poslat reset
  renderResend();
})();
</script>
