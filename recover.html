<!doctype html>
<html lang="cs">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reset hesla</title>
<script src="https://cdn.tailwindcss.com"></script>

<body class="min-h-screen bg-slate-50 text-slate-900">
  <main class="max-w-md mx-auto p-6 space-y-4">
    <h1 class="text-xl font-semibold">Nastavit nové heslo</h1>
    <div id="content" class="p-4 bg-white rounded-2xl shadow space-y-3"><p>Načítám…</p></div>
  </main>

  <script type="module" src="./src/supabase.js"></script>
  <script type="module">
  import { supabase } from './src/supabase.js';
  const root = document.getElementById('content');
  const p = new URLSearchParams(location.hash.slice(1));
  if (p.get('type') !== 'recovery') { root.innerHTML = '<p>Odkaz je neplatný nebo vypršel.</p>'; throw null; }

  const { error } = await supabase.auth.setSession({
    access_token: p.get('access_token'),
    refresh_token: p.get('refresh_token')
  });
  if (error) { root.textContent = 'Chyba: ' + error.message; throw null; }

  history.replaceState({}, document.title, location.pathname); // schovej tokeny

  root.innerHTML = `
    <input id="a" type="password" class="w-full border rounded p-2" placeholder="Nové heslo" />
    <input id="b" type="password" class="w-full border rounded p-2" placeholder="Potvrdit heslo" />
    <div class="flex gap-2"><button id="ok" class="px-3 py-2 bg-slate-900 text-white rounded">Uložit</button></div>
    <p id="msg" class="text-sm text-slate-500"></p>
  `;
  const msg = document.getElementById('msg');
  document.getElementById('ok').onclick = async () => {
    const a = document.getElementById('a').value.trim();
    const b = document.getElementById('b').value.trim();
    if (!a || a !== b) { msg.textContent = 'Hesla se neshodují.'; return; }
    const { error } = await supabase.auth.updateUser({ password: a });
    if (error) { msg.textContent = 'Chyba: ' + error.message; return; }
    await supabase.auth.signOut();
    location.assign('/'); // kam po úspěchu
  };
  </script>
</body>
</html>
