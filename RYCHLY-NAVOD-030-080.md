# Rychl√Ω n√°vod - Jak dokonƒçit implementaci modul≈Ø 030-080

Tento dokument poskytuje krok-za-krokem n√°vod, jak dokonƒçit implementaci modul≈Ø 060-080.

## üöÄ Aktu√°ln√≠ stav

‚úÖ **HOTOVO:**
- Vytvo≈ôena struktura modul≈Ø 060, 070, 080
- P≈ôipraveny SQL migrace pro datab√°zov√© tabulky
- Moduly jsou viditeln√© v aplikaci (zakomentov√°ny v modules.index.js)
- Placeholder UI pro v≈°echny tiles a forms

‚è≥ **ZB√ùV√Å:**
- Spustit SQL migrace v Supabase
- Implementovat CRUD operace
- Implementovat funkƒçn√≠ UI

---

## üìù Krok 1: Spu≈°tƒõn√≠ SQL migrac√≠ (15-30 minut)

### V Supabase Dashboard:

1. P≈ôihlaste se do [Supabase Dashboard](https://supabase.com)
2. Otev≈ôete SQL Editor
3. Postupnƒõ spus≈•te n√°sleduj√≠c√≠ migrace:

#### a) Migration 003 - Roz≈°√≠≈ôen√≠ subjects tabulky
```bash
# Soubor: docs/tasks/supabase-migrations/003_add_subjects_missing_fields.sql
```
**Co dƒõl√°:**
- P≈ôid√° nov√° pole do subjects tabulky (kontaktn√≠_osoba, bankovn√≠_√∫ƒçty, atd.)
- Pot≈ôebn√© pro moduly 030 (Pronaj√≠matel) a 050 (N√°jemn√≠k)

**Oƒçek√°van√Ω v√Ωstup:**
```
Migration 003 completed: Added missing fields to subjects table
```

#### b) Migration 004 - Tabulky pro smlouvy
```bash
# Soubor: docs/tasks/supabase-migrations/004_create_contracts_table.sql
```
**Co dƒõl√°:**
- Vytvo≈ô√≠ tabulky `contracts` a `handover_protocols`
- Pot≈ôebn√© pro modul 060 (Smlouvy)

**Oƒçek√°van√Ω v√Ωstup:**
```
Migration 004 completed: contracts and handover_protocols tables created
```

#### c) Migration 005 - Tabulky pro slu≈æby
```bash
# Soubor: docs/tasks/supabase-migrations/005_create_services_tables.sql
```
**Co dƒõl√°:**
- Vytvo≈ô√≠ tabulky `service_definitions` a `contract_service_lines`
- P≈ôedvypln√≠ katalog z√°kladn√≠mi slu≈æbami (voda, elekt≈ôina, plyn, atd.)
- Pot≈ôebn√© pro modul 070 (Slu≈æby)

**Oƒçek√°van√Ω v√Ωstup:**
```
Migration 005 completed: service_definitions and contract_service_lines tables created
```

#### d) Migration 006 - Tabulky pro platby
```bash
# Soubor: docs/tasks/supabase-migrations/006_create_payments_tables.sql
```
**Co dƒõl√°:**
- Vytvo≈ô√≠ tabulky `payments`, `payment_service_items`, `payment_allocations`
- Pot≈ôebn√© pro modul 080 (Platby)

**Oƒçek√°van√Ω v√Ωstup:**
```
Migration 006 completed: payments, payment_service_items, and payment_allocations tables created
```

### Kontrola:
Po spu≈°tƒõn√≠ migrac√≠ zkontrolujte v Supabase Table Editor, ≈æe byly vytvo≈ôeny nov√© tabulky:
- ‚úÖ contracts
- ‚úÖ handover_protocols
- ‚úÖ service_definitions
- ‚úÖ contract_service_lines
- ‚úÖ payments
- ‚úÖ payment_service_items
- ‚úÖ payment_allocations

---

## üìù Krok 2: Aktualizace type-schemas (30-60 minut)

### Upravte soubor: `/src/lib/type-schemas/subjects.js`

P≈ôidejte nov√° pole podle n√°vodu v `docs/tasks/type-schemas-extensions.js`:

#### Pro firmy (osvc, firma, spolek, stat):
```javascript
// Kontaktn√≠ osoba
{ key: 'kontaktni_osoba_jmeno', label: 'Kontaktn√≠ osoba - Jm√©no', type: 'text' },
{ key: 'kontaktni_osoba_email', label: 'Kontaktn√≠ osoba - E-mail', type: 'email' },
{ key: 'kontaktni_osoba_telefon', label: 'Kontaktn√≠ osoba - Telefon', type: 'text' },
```

#### Pro v≈°echny typy:
```javascript
// Bankovn√≠ √∫ƒçet
{ key: 'banka_nazev', label: 'Banka', type: 'text' },
{ key: 'banka_iban', label: 'IBAN', type: 'text' },
{ key: 'banka_bic', label: 'BIC / SWIFT', type: 'text' },
```

#### Pro n√°jemn√≠ky:
```javascript
// Doruƒçovac√≠ adresa
{ key: 'dorucovaci_ulice', label: 'Doruƒçovac√≠ adresa - Ulice', type: 'text' },
{ key: 'dorucovaci_cislo_popisne', label: 'ƒå√≠slo popisn√©', type: 'text' },
{ key: 'dorucovaci_mesto', label: 'Mƒõsto', type: 'text' },
{ key: 'dorucovaci_psc', label: 'PSƒå', type: 'text' },
```

### Implementujte transformaƒçn√≠ funkce

Vytvo≈ôte helper funkce pro konverzi mezi flat formul√°≈ôem a JSON strukturou v DB:
```javascript
// P≈ôed ulo≈æen√≠m do DB
function prepareSubjectForDb(formData) {
  const { 
    kontaktni_osoba_jmeno, 
    kontaktni_osoba_email, 
    kontaktni_osoba_telefon,
    banka_nazev,
    banka_iban,
    banka_bic,
    ...rest 
  } = formData;
  
  return {
    ...rest,
    kontaktni_osoba: kontaktni_osoba_jmeno ? {
      jmeno: kontaktni_osoba_jmeno,
      email: kontaktni_osoba_email,
      telefon: kontaktni_osoba_telefon
    } : null,
    bankovni_ucty: banka_iban ? [{
      banka: banka_nazev,
      iban: banka_iban,
      bic: banka_bic
    }] : null
  };
}

// Po naƒçten√≠ z DB
function flattenSubjectForForm(dbRecord) {
  return {
    ...dbRecord,
    kontaktni_osoba_jmeno: dbRecord.kontaktni_osoba?.jmeno,
    kontaktni_osoba_email: dbRecord.kontaktni_osoba?.email,
    kontaktni_osoba_telefon: dbRecord.kontaktni_osoba?.telefon,
    banka_nazev: dbRecord.bankovni_ucty?.[0]?.banka,
    banka_iban: dbRecord.bankovni_ucty?.[0]?.iban,
    banka_bic: dbRecord.bankovni_ucty?.[0]?.bic
  };
}
```

---

## üìù Krok 3: Implementace CRUD operac√≠ (2-4 hodiny)

### Modul 060 - Smlouvy

Upravte `/src/modules/060-smlouva/db.js`:

```javascript
// P≈ô√≠klad: listContracts
export async function listContracts(options = {}) {
  const { status, showArchived = false, limit = 500 } = options;
  
  let query = supabase
    .from('contracts')
    .select(`
      *,
      landlord:subjects!landlord_id(id, display_name),
      tenant:subjects!tenant_id(id, display_name),
      unit:units(id, oznaceni),
      property:properties(id, nazev)
    `)
    .order('created_at', { ascending: false })
    .limit(limit);
  
  if (status) query = query.eq('stav', status);
  if (!showArchived) query = query.eq('archived', false);
  
  const { data, error } = await query;
  return { data: data || [], error };
}
```

**Implementujte podobnƒõ:**
- `getContract(id)`
- `upsertContract(contract)`
- `archiveContract(id)`

### Modul 070 - Slu≈æby

Upravte `/src/modules/070-sluzby/db.js`:

```javascript
export async function listServiceDefinitions(options = {}) {
  const { kategorie, aktivni = true } = options;
  
  let query = supabase
    .from('service_definitions')
    .select('*')
    .order('nazev');
  
  if (kategorie) query = query.eq('kategorie', kategorie);
  if (aktivni !== null) query = query.eq('aktivni', aktivni);
  
  const { data, error } = await query;
  return { data: data || [], error };
}
```

### Modul 080 - Platby

Upravte `/src/modules/080-platby/db.js`:

```javascript
export async function listPayments(options = {}) {
  const { contract_id, status } = options;
  
  let query = supabase
    .from('payments')
    .select(`
      *,
      contract:contracts(cislo_smlouvy),
      party:subjects!party_id(display_name)
    `)
    .order('payment_date', { ascending: false });
  
  if (contract_id) query = query.eq('contract_id', contract_id);
  if (status) query = query.eq('status', status);
  
  const { data, error } = await query;
  return { data: data || [], error };
}
```

---

## üìù Krok 4: Implementace UI - P≈ôehledov√© tiles (2-3 hodiny)

### Vzorov√Ω p≈ô√≠klad pro modul 060 - Smlouvy

Upravte `/src/modules/060-smlouva/tiles/prehled.js`:

```javascript
import { renderTable } from '/src/ui/table.js';
import { listContracts } from '/src/modules/060-smlouva/db.js';
import { setBreadcrumb } from '/src/ui/breadcrumb.js';

export default async function render(root) {
  setBreadcrumb(document.getElementById('crumb'), [
    { icon: 'home', label: 'Dom≈Ø', href: '#/' },
    { icon: 'description', label: 'Smlouvy', href: '#/m/060-smlouva' },
    { icon: 'list', label: 'P≈ôehled' }
  ]);

  const { data, error } = await listContracts({});
  
  if (error) {
    root.innerHTML = `<div class="p-4 text-red-600">Chyba: ${error.message}</div>`;
    return;
  }

  const columns = [
    { key: 'cislo_smlouvy', label: 'ƒå√≠slo smlouvy', sortable: true },
    { key: 'tenant_name', label: 'N√°jemn√≠k' },
    { key: 'unit_name', label: 'Jednotka' },
    { key: 'datum_zacatek', label: 'Od', sortable: true },
    { key: 'datum_konec', label: 'Do' },
    { key: 'najem_vyse', label: 'N√°jem (Kƒç)', sortable: true },
    { key: 'stav', label: 'Stav' }
  ];

  renderTable(root, {
    columns,
    rows: data.map(r => ({
      ...r,
      tenant_name: r.tenant?.display_name || '‚Äî',
      unit_name: r.unit?.oznaceni || '‚Äî'
    })),
    options: {
      moduleId: '060-smlouva',
      onRowDblClick: row => {
        window.location.hash = `#/m/060-smlouva/f/detail?id=${row.id}`;
      }
    }
  });
}
```

**Implementujte podobnƒõ pro:**
- Modul 070 - katalog slu≈æeb
- Modul 080 - p≈ôehled plateb

---

## üìù Krok 5: Testov√°n√≠ (1-2 hodiny)

### Kontroln√≠ seznam:

1. **Moduly se naƒç√≠taj√≠**
   - [ ] Modul 060 se zobrazuje v sidebaru
   - [ ] Modul 070 se zobrazuje v sidebaru
   - [ ] Modul 080 se zobrazuje v sidebaru

2. **P≈ôehledov√© tiles funguj√≠**
   - [ ] Modul 060 - zobrazuje seznam smluv
   - [ ] Modul 070 - zobrazuje katalog slu≈æeb
   - [ ] Modul 080 - zobrazuje platby

3. **CRUD operace funguj√≠**
   - [ ] Lze vytvo≈ôit novou smlouvu
   - [ ] Lze p≈ôidat slu≈æbu do katalogu
   - [ ] Lze evidovat platbu

4. **Vazby mezi entitami**
   - [ ] Smlouva se spr√°vnƒõ propoj√≠ s pronaj√≠matelem, n√°jemn√≠kem a jednotkou
   - [ ] Slu≈æby se spr√°vnƒõ p≈ôi≈ôad√≠ ke smlouvƒõ
   - [ ] Platba se spr√°vnƒõ propoj√≠ se smlouvou

---

## üîß Troubleshooting

### Probl√©m: Migrace sel≈æe s chybou "relation already exists"
**≈òe≈°en√≠:** Tabulka u≈æ existuje. P≈ôeskoƒçte tuto migraci nebo ji upravte na `CREATE TABLE IF NOT EXISTS`.

### Probl√©m: RLS policy odm√≠t√° p≈ô√≠stup
**≈òe≈°en√≠:** Zkontrolujte, ≈æe jste p≈ôihl√°≈°eni a m√°te spr√°vnou roli v `profiles` tabulce.

### Probl√©m: Foreign key constraint fails
**≈òe≈°en√≠:** Ujistƒõte se, ≈æe existuj√≠ z√°znamy v propojen√Ωch tabulk√°ch (subjects, units, properties).

### Probl√©m: Modul se nezobrazuje v sidebaru
**≈òe≈°en√≠:** Zkontrolujte, ≈æe je modul odkomentov√°n v `src/app/modules.index.js`.

---

## üìö U≈æiteƒçn√© odkazy

- **Dokumentace Supabase**: https://supabase.com/docs
- **Module quick reference**: `docs/module-quick-reference.md`
- **Database schema**: `docs/database-schema.md`
- **Specifikace**: `smlouvy_moduly_030-080.md`

---

## üí° Tipy

1. **Zaƒçnƒõte s modulem 070 (Slu≈æby)** - je nejjednodu≈°≈°√≠, m√° p≈ôedvyplnƒõn√Ω katalog
2. **Pou≈æijte modul 040 jako referenci** - je kompletnƒõ implementovan√Ω
3. **Testujte pr≈Øbƒõ≈ænƒõ** - po ka≈æd√© zmƒõnƒõ otestujte, ≈æe aplikace funguje
4. **Commitujte ƒçasto** - mal√© commity jsou lep≈°√≠ ne≈æ velk√©

---

**Pozn√°mka:** Pro podrobn√© p≈ô√≠klady k√≥du se pod√≠vejte do existuj√≠c√≠ch modul≈Ø:
- `/src/modules/010-sprava-uzivatelu/` - referenƒçn√≠ implementace
- `/src/modules/040-nemovitost/` - kompletn√≠ modul s vazbami

**√öspƒõ≈°nou implementaci!** üöÄ
