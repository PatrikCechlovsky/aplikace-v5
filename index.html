<!doctype html>
<html lang="cs">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aplikace – Auth</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="color-scheme" content="light dark" />
  </head>

  <body class="min-h-screen bg-slate-50 text-slate-900">
    <main class="max-w-md mx-auto p-6 space-y-6">

      <!-- Login blok -->
      <section id="authBox" class="space-y-4">
        <h1 class="text-xl font-semibold">Přihlášení</h1>
        <div class="p-4 bg-white rounded-2xl shadow space-y-3">
          <input id="email" type="email" class="w-full border rounded p-2" placeholder="email" />
          <input id="pass"  type="password" class="w-full border rounded p-2" placeholder="heslo" />
          <div class="flex gap-2">
            <button id="btn-login"  class="px-3 py-2 bg-slate-900 text-white rounded">Přihlásit</button>
            <button id="btn-signup" class="px-3 py-2 border rounded">Registrovat</button>
            <button id="btn-forgot" class="px-3 py-2 border rounded">Zapomenuté heslo</button>
          </div>
          <p id="msg" class="text-sm text-slate-500"></p>
        </div>
      </section>

      <!-- „Domů“ po přihlášení -->
      <section id="appBox" class="hidden space-y-4">
        <h1 class="text-xl font-semibold">Domů</h1>
        <div class="p-4 bg-white rounded-2xl shadow space-y-3">
          <p class="text-sm">Jste přihlášen jako <b id="userEmail">—</b>.</p>
          <div class="flex gap-2">
            <a href="./app.html" class="px-3 py-2 bg-slate-900 text-white rounded">Hlavní stránka</a>
            <button id="btn-logout" class="px-3 py-2 border rounded">Odhlásit</button>
          </div>
        </div>
      </section>

    </main>

    <!-- Supabase init -->
    <script type="module" src="./src/supabase.js"></script>

    <!-- Logika stránky -->
    <script type="module">
      import { supabase } from './src/supabase.js';

      const authBox   = document.getElementById('authBox');
      const appBox    = document.getElementById('appBox');
      const userEmail = document.getElementById('userEmail');
      const msg       = document.getElementById('msg');

      const btnLogin  = document.getElementById('btn-login');
      const btnSignup = document.getElementById('btn-signup');
      const btnForgot = document.getElementById('btn-forgot');
      const btnLogout = document.getElementById('btn-logout');

      function render(session){
        const signedIn = !!session;
        authBox.classList.toggle('hidden', signedIn);
        appBox .classList.toggle('hidden', !signedIn);
        if (userEmail) userEmail.textContent = session?.user?.email ?? '—';
      }

      // Inicializace UI dle session
      (async () => {
        const { data } = await supabase.auth.getSession();
        render(data.session);
      })();

      // Reakce na změnu stavu
      supabase.auth.onAuthStateChange((_e, session) => render(session));

      // Přihlášení
      btnLogin?.addEventListener('click', async () => {
        msg.textContent = 'Přihlašuji…';
        const email = (document.getElementById('email').value || '').trim();
        const pass  = (document.getElementById('pass').value  || '').trim();
        const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
        msg.textContent = error ? ('Chyba: ' + error.message) : 'OK';
      });

      // Registrace
      btnSignup?.addEventListener('click', async () => {
        msg.textContent = 'Zakládám účet…';
        const email = (document.getElementById('email').value || '').trim();
        const pass  = (document.getElementById('pass').value  || '').trim();
        const { error } = await supabase.auth.signUp({ email, password: pass });
        msg.textContent = error ? ('Chyba: ' + error.message)
                                : 'OK – zkontroluj e-mail, pokud je vyžadováno potvrzení.';
      });

      // Reset hesla
      btnForgot?.addEventListener('click', async () => {
        msg.textContent = 'Posílám odkaz…';
        const email = (document.getElementById('email').value || '').trim();
        const { error } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo: location.origin + '/recover.html'
        });
        msg.textContent = error ? ('Chyba: ' + error.message) : 'Hotovo – zkontroluj e-mail.';
      });

      // ODHLÁŠENÍ – „nezničitelné“ + úplný purge tokenů
      btnLogout?.addEventListener('click', async () => {
        try {
          // 1) Lokální signOut (odstraní session v prohlížeči)
          await supabase.auth.signOut({ scope: 'local' });
        } catch (_) {}

        try {
          // 2) Best-effort globální signOut (může hodit 403 – ignorujeme)
          await supabase.auth.signOut();
        } catch (e) {
          console.debug('Server signOut skipped:', e?.message || e);
        }

        try {
          // 3) Extra jistota – vyčistit všechny možné Supabase klíče
          const purge = (store) => {
            const keys = [];
            for (let i = 0; i < store.length; i++) {
              const k = store.key(i);
              if (k && k.startsWith('sb-')) keys.push(k);
            }
            keys.forEach(k => store.removeItem(k));
          };
          purge(localStorage);
          purge(sessionStorage);
        } catch (_) {}

        // 4) Tvrdý reload na index s cache busterem
        const url = new URL('./index.html', location.href);
        url.searchParams.set('_', Date.now().toString());
        window.location.replace(url.toString());
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  </body>
</html>
